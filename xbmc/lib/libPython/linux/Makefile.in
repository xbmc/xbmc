ARCH=@ARCH@
SHELL=/bin/bash
SYSDIR=../../../../system/python
SO=python24-$(ARCH).so
LIB=$(SYSDIR)/$(SO)
ZIP=$(SYSDIR)/python24.zip  ##Should probably add arch here too
DIRS=../Python
WRAPPER=../../../cores/DllLoader/exports/wrapper.o
WRAPPERDEF=$(WRAPPER:.o=.def)
PYWRAP=wrapper_python.o
PYWRAPDEF=$(PYWRAP:.o=.def)
ifeq ($(ARCH), x86_64-linux)
	PYLIBDIR=lib.linux-x86_64-2.4
else
	PYLIBDIR=lib.linux-i686-2.4
endif
PYDIRS=bsddb compiler curses distutils email encodings hotshot idlelib \
			 lib-old lib-tk logging site-packages xml
ifeq ($(ARCH), x86-osx)
	PYDIRS+=plat-darwin
	@#PYDIRS+=plat-mac
else
	PYDIRS+=plat-linux2
endif

PY=$(wildcard ../Python/Lib/*.py) 
PY+=$(foreach DIR, $(PYDIRS), $(wildcard ../Python/Lib/$(DIR)/*.py))
PY+=$(foreach DIR, $(PYDIRS), $(wildcard ../Python/Lib/$(DIR)/*/*.py))
PY+=$(foreach DIR, $(PYDIRS), $(wildcard ../Python/Lib/$(DIR)/*/*/*.py))
PYC=$(addsuffix c, $(PY))
PYO=$(addsuffix o, $(PY))

.PHONY: compile

all: $(LIB)
	$(MAKE) $(ZIP)

ifeq ($(ARCH), x86-osx)
$(LIB): tmp ../../../../tools/Mach5/Makefile
	gcc -bundle -flat_namespace -undefined suppress -shared \
	    -o python24-osx.so tmp/*.o
	$(MAKE) -C ../../../../tools/Mach5/ python
	cp ../../../../tools/Mach5/output.so $@
	rm -rf tmp
else
$(LIB): $(WRAPPER) $(WRAPPERDEF) $(PYWRAP) $(PYWRAPDEF) ../Python/libpython2.4.a
	$(CC) -shared -o $@ -Wl,--whole-archive ../Python/libpython2.4.a \
		-Wl,--no-whole-archive `cat wrapper_python.def` wrapper_python.o \
		`cat ../../../cores/DllLoader/exports/wrapper.def` \
		../../../cores/DllLoader/exports/wrapper.o
endif

$(ZIP): $(PYC) $(PYO)
	pushd ../Python/build/$(PYLIBDIR)/ && \
		zip -0guq ../../$@ *.so; \
		popd
	pushd ../Python/Lib/ && \
		zip -0gurq ../$@ *.py* $(PYDIRS) -x *.svn* *test*; \
		popd

../Python/libpython2.4.a: compile
	$(MAKE) -C ../Python

%pyc: %py
	@echo Compiling $@
	@LD_PRELOAD=../Python/libpython2.4.so.1.0 ../Python/python \
		../Python/Lib/py_compile.py $<

%pyo: %py
	@echo Compiling $@
	@LD_PRELOAD=../Python/libpython2.4.so.1.0 ../Python/python -O \
		../Python/Lib/py_compile.py $<

$(PYWRAP): $(PYWRAP:.o=.c)
	 $(CC) -fPIC -o $@ -D_FILE_DEFINED -D_REENTRANT -D_LARGEFILE64_SOURCE -D_FILE_OFFSET_BITS=64 -c $<

$(PYWRAPDEF): $(PYWRAPDEF:.def=.c)
	(echo -n "-Wl"; grep PYTHON_WRAP wrapper_python.c | grep -v define | \
		awk -F ')' '{print $$1}' | awk -F'(' '{print $$2}' | grep -v '^l*stat$$' | \
		awk '{printf(",-wrap,%s",$$0);}') > wrapper_python.def

tmp: ../Python/libpython2.4.a
	mkdir -p tmp;
	(cd ./tmp && ar x ../../Python/libpython2.4.a)

clean:
	for d in $(DIRS); do make -C $$d clean; done
	rm -f $(LIB) $(ZIP) $(PYC) $(PYO) ../Python/libpython2.4.a $(PYWRAP) $(PYWRAPDEF)

distclean:
	for d in $(DIRS); do make -C $$d distclean; done
	rm -f $(LIB) $(ZIP) $(PYC) $(PYO) ../Python/libpython2.4.a $(PYWRAP) $(PYWRAPDEF)
