
CC=@CC@
CXX=@CXX@
SHELL=/bin/bash
LDFLAGS=-shared -fPIC -rdynamic
ARCH=@ARCH@
SYSDIR=../../../../system/players/dvdplayer
WRAPPER=../../DllLoader/exports/wrapper.o
DIRS=	ffmpeg \
	libDVDCSS \
	libdts \
	libdvdnav \
	libfaad2 \
	libmad \
#	liba52 \
#	libmpeg2 \

LIBS=	avutil-51-$(ARCH).so \
	avcodec-51-$(ARCH).so \
	avformat-51-$(ARCH).so \
	postproc-51-$(ARCH).so \
	swscale-51-$(ARCH).so \
	libDVDCSS-$(ARCH).so \
	libdts-$(ARCH).so \
	libdvdnav-$(ARCH).so \
	libfaad-$(ARCH).so \
	libmad-$(ARCH).so \
#	liba52-$(ARCH).so \
#	libmpeg2-$(ARCH).so \

.PHONY: $(DIRS) codecs

codecs: $(addprefix $(SYSDIR)/, $(LIBS));

$(SYSDIR)/avutil-51-$(ARCH).so: ffmpeg/libavutil/libavutil.so
	$(CC) -o $@ $(LDFLAGS) --soname,$@ ffmpeg/libavutil/*.o

$(SYSDIR)/avcodec-51-$(ARCH).so: $(WRAPPER) ffmpeg/libavcodec/libavcodec.so
	$(CC) -o $@ $(LDFLAGS) --soname,$@ /usr/lib/libfaac.a ffmpeg/libavcodec/*.o \
		ffmpeg/libavcodec/i386/*.o `cat $(WRAPPER:.o=.def)` $(WRAPPER)

$(SYSDIR)/avformat-51-$(ARCH).so: $(WRAPPER) ffmpeg/libavformat/libavformat.so
	$(CC) -o $@ $(LDFLAGS) --soname,$@ ffmpeg/libavformat/*.o \
		`cat $(WRAPPER:.o=.def)` $(WRAPPER)

$(SYSDIR)/swscale-51-$(ARCH).so: $(WRAPPER) ffmpeg/libswscale/libswscale.so
	$(CC) -o $@ $(LDFLAGS) --soname,$@ ffmpeg/libswscale/*.o \
		`cat $(WRAPPER:.o=.def)` $(WRAPPER)

$(SYSDIR)/postproc-51-$(ARCH).so: $(WRAPPER) ffmpeg/libpostproc/libpostproc.so
	$(CC) -o $@ $(LDFLAGS) --soname,$@ ffmpeg/libpostproc/*.o \
		`cat $(WRAPPER:.o=.def)` $(WRAPPER)

$(SYSDIR)/libdts-$(ARCH).so: $(WRAPPER) libdts/libdts/libdts.a
	$(CC) -o $@ $(LDFLAGS) --soname,$@ libdts/libdts/bitstream.o \
		libdts/libdts/downmix.o libdts/libdts/parse.o -Wl`sed 's/[(\*]/ /g' \
		$(WRAPPER:.o=.c) | grep -v bash | awk \
		'/__wrap/ {out=out","$$2} END {print out}' | sed 's/__wrap_/-wrap,/g'` 

$(SYSDIR)/libDVDCSS-$(ARCH).so: $(WRAPPER) libDVDCSS/src/libdvdcss.la
	$(CC) -o $@ $(LDFLAGS) --soname,$@ libDVDCSS/src/*.o -Wl`sed 's/[(\*]/ /g' $(WRAPPER:.o=.c) | grep -v bash | awk '/__wrap/ {out=out","$$2} END {print out}' | sed 's/__wrap_/-wrap,/g'`

$(SYSDIR)/libdvdnav-$(ARCH).so: $(WRAPPER) libDVDCSS/src/libdvdcss.la libdvdnav/src/libdvdnav.la libdvdnav/src/vm/libdvdvm.la libdvdnav/src/dvdread/libdvdread.la
	$(CC) -o $@ $(LDFLAGS) --soname,$@ libDVDCSS/src/*.o libdvdnav/src/*.o libdvdnav/src/vm/*.o libdvdnav/src/dvdread/*.o \-Wl`sed 's/[(\*]/ /g' $(WRAPPER:.o=.c) | grep -v bash | awk '/__wrap/ {out=out","$$2} END {print out}' | sed 's/__wrap_/-wrap,/g'`

$(SYSDIR)/libfaad-$(ARCH).so: $(WRAPPER) libfaad2/libfaad/libfaad.la
	$(CC) -o $@ $(LDFLAGS) --soname,$@ libfaad2/libfaad/*.o \
		`cat $(WRAPPER:.o=.def)`

$(SYSDIR)/libmad-$(ARCH).so: libmad/libmad.la
	cp libmad/.libs/libmad.so $@

ffmpeg/libavutil/libavutil.so     : ffmpeg;
ffmpeg/libavformat/libavformat.so : ffmpeg;
ffmpeg/libavcodec/libavcodec.so   : ffmpeg;
ffmpeg/libswscale/libswscale.so   : ffmpeg;
ffmpeg/libpostproc/libpostproc.so : ffmpeg;
ffmpeg:
	$(MAKE) -C $@

libdts/libdts/libdts.a : libdts;
libdts:
	$(MAKE) -C $@

libDVDCSS/src/libdvdcss.la: libDVDCSS;
libDVDCSS:
	$(MAKE) -C $@

libdvdnav/src/libdvdnav.la          : libdvdnav;
libdvdnav/src/vm/libdvdvm.la        : libdvdnav;
libdvdnav/src/dvdread/libdvdread.la : libdvdnav;
libdvdnav:
	$(MAKE) -C $@

libfaad2/libfaad/libfaad.la: libfaad2;
libfaad2:
	$(MAKE) -C $@

libmad/libmad.la: libmad;
libmad:
	$(MAKE) -C $@

clean:
	rm -f $(addprefix $(SYSDIR)/, $(LIBS))
	for i in $(DIRS); do $(MAKE) -C "$$i" clean; done

distclean:
	rm -f $(addprefix $(SYSDIR)/, $(LIBS))
	for i in $(DIRS); do $(MAKE) -C "$$i" distclean; done

