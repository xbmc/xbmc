
default: python24.zip python24-@ARCH@.so
	cp python24.zip python24-@ARCH@.so  ../../../../system/python

python24.zip:
	(cd tmp2/lib/python2.4; mv lib-dynload/* .; zip -0 -r ../../../python24.zip *)
	rm -rf tmp2

python24-@ARCH@.so : wrapper_python.o ../Python/libpython2.4.a wrapper_python.def ../../../cores/DllLoader/exports/wrapper.def ../../../cores/DllLoader/exports/wrapper.o ../Python/Makefile
	if [ \! -d tmp ]; then mkdir tmp; fi
	(cd ./tmp; ar x ../../Python/libpython2.4.a)
	gcc -shared -o $@ tmp/*.o `cat wrapper_python.def` wrapper_python.o `cat ../../../cores/DllLoader/exports/wrapper.def` ../../../cores/DllLoader/exports/wrapper.o
	rm -rf tmp

wrapper_python.o : wrapper_python.c
	gcc -fPIC -o $@ -D_FILE_DEFINED -D_REENTRANT -D_LARGEFILE64_SOURCE -D_FILE_OFFSET_BITS=64 -c $<

wrapper_python.def : wrapper_python.c
	(echo -n "-Wl"; grep PYTHON_WRAP wrapper_python.c | grep -v define | awk -F ')' '{print $$1}' | awk -F'(' '{print $$2}' | grep -v '^l*stat$$' | awk '{printf(",-wrap,%s",$$0);}') > wrapper_python.def

../Python/Makefile:
	(cd ../Python; ./configure --enable-ipv6 --enable-unicode=ucs4 --without-cxx --enable-shared --prefix=`pwd`/../linux/tmp)
	(cd ../Python; sed -i 's/define HAVE_GETC_UNLOCKED 1/undef HAVE_GETC_UNLOCKED/' pyconfig.h)

../Python/libpython2.4.a:
	$(MAKE) -C ../Python libinstall sharedinstall

clean:
	$(RM) *.so *.o *.def
	if [ -e ../Python/Makefile ]; then $(MAKE) -C ../Python clean; fi
