DIRS=guilib xbmc xbmc/FileSystem xbmc/FileSystem/MusicDatabaseDirectory xbmc/FileSystem/VideoDatabaseDirectory xbmc/cores xbmc/cores/paplayer xbmc/cores/DllLoader xbmc/cores/DllLoader/exports xbmc/cores/DllLoader/exports/util xbmc/xbox xbmc/linux xbmc/visualizations xbmc/screensavers xbmc/utils guilib/common guilib/tinyXML xbmc/lib/sqLite xbmc/lib/libPython xbmc/lib/libPython/xbmcmodule xbmc/lib/libPython/linux xbmc/lib/libscrobbler xbmc/lib/UnrarXLib xbmc/lib/libGoAhead xbmc/lib/libUPnP xbmc/cores/dvdplayer xbmc/cores/dvdplayer/DVDSubtitles xbmc/cores/dvdplayer/DVDInputStreams xbmc/cores/dvdplayer/DVDCodecs xbmc/cores/dvdplayer/DVDCodecs/Audio xbmc/cores/dvdplayer/DVDCodecs/Video xbmc/cores/dvdplayer/DVDCodecs/Overlay xbmc/cores/dvdplayer/DVDCodecs/Overlay/libspucc xbmc/cores/dvdplayer/DVDDemuxers xbmc/cores/VideoRenderers xbmc/cores/VideoRenderers/VideoShaders xbmc/cdrip xbmc/lib/libcmyth tools/EventClients xbmc/lib/libRTMP xbmc/cores/paplayer/AC3Codec xbmc/cores/paplayer/ADPCMCodec xbmc/cores/paplayer/AACCodec xbmc/cores/paplayer/CubeCodec xbmc/cores/paplayer/NSFCodec xbmc/cores/paplayer/MIDCodec xbmc/cores/paplayer/SIDCodec xbmc/cores/paplayer/WavPackCodec xbmc/cores/paplayer/GYMCodec xbmc/cores/paplayer/DCACodec xbmc/cores/paplayer/YMCodec/StSoundLibrary xbmc/cores/paplayer/ModuleCodec xbmc/cores/paplayer/MPCCodec xbmc/cores/paplayer/SPCCodec xbmc/cores/paplayer/MP3Codec xbmc/cores/paplayer/flac-1.2.1/ xbmc/cores/paplayer/MACDll xbmc/cores/paplayer/vorbisfile tools/XBMCTex xbmc/cores/dvdplayer/Codecs xbmc/lib/cximage-6.0 xbmc/lib/libXDAAP

LIBS=@LIBS@
DEBUG_FLAGS=@DEBUG_FLAGS@
CFLAGS=@CFLAGS@
CXXFLAGS=@CXXFLAGS@
LDFLAGS=@LDFLAGS@
INCLUDES=@INCLUDES@

all : compile 
	$(MAKE) xbmc.bin
	$(MAKE) xbmc-xrandr
	$(MAKE) XBMCTex
	$(MAKE) skin/Project\ Mayhem\ III/media/Textures.xpr

.PHONY : guilib xbmc filesystem musicdatabase videodatabase cores paplayer dllloader exports xbox linux visualizations screensavers utils common tinyxml sqllite libscrobbler unrarxlib libpython libgoahead compile dvdplayer libupnp libcmyth eventclients librtmp papcodecs dvdcodecs imagelib

skin/Project\ Mayhem\ III/media/Textures.xpr:
	 @tools/XBMCTex/XBMCTex -input "\"skin/Project Mayhem III/media\"" -output "\"skin/Project Mayhem III\media\Textures.xpr\""

guilib: 
	$(MAKE) -C guilib
xbmc: 
	$(MAKE) -C xbmc
filesystem: 
	$(MAKE) -C xbmc/FileSystem
musicdatabase: 
	$(MAKE) -C xbmc/FileSystem/MusicDatabaseDirectory
videodatabase: 
	$(MAKE) -C xbmc/FileSystem/VideoDatabaseDirectory
cores: 
	$(MAKE) -C xbmc/cores
paplayer: 
	$(MAKE) -C xbmc/cores/paplayer
dllloader: exports
	$(MAKE) -C xbmc/cores/DllLoader
exports:
	$(MAKE) -C xbmc/cores/DllLoader/exports
	$(MAKE) -C xbmc/cores/DllLoader/exports/util
xbox: 
	$(MAKE) -C xbmc/xbox
linux: 
	$(MAKE) -C xbmc/linux
visualizations: 
	$(MAKE) -C xbmc/visualizations
screensavers: 
	$(MAKE) -C xbmc/screensavers
utils: 
	$(MAKE) -C xbmc/utils
common: 
	$(MAKE) -C guilib/common
tinyxml: 
	$(MAKE) -C guilib/tinyXML
sqllite: 
	$(MAKE) -C xbmc/lib/sqLite
libscrobbler: 
	$(MAKE) -C xbmc/lib/libscrobbler
unrarxlib: 
	$(MAKE) -C xbmc/lib/UnrarXLib
libpython: dllloader
	$(MAKE) -C xbmc/lib/libPython
	$(MAKE) -C xbmc/lib/libPython/xbmcmodule
	$(MAKE) -C xbmc/lib/libPython/linux
libgoahead: 
	$(MAKE) -C xbmc/lib/libGoAhead
libupnp: 
	$(MAKE) -C xbmc/lib/libUPnP
dvdplayer:
	$(MAKE) -C xbmc/cores/dvdplayer
	$(MAKE) -C xbmc/cores/dvdplayer/DVDSubtitles
	$(MAKE) -C xbmc/cores/dvdplayer/DVDInputStreams
	$(MAKE) -C xbmc/cores/dvdplayer/DVDCodecs
	$(MAKE) -C xbmc/cores/dvdplayer/DVDCodecs/Audio
	$(MAKE) -C xbmc/cores/dvdplayer/DVDCodecs/Video
	$(MAKE) -C xbmc/cores/dvdplayer/DVDCodecs/Overlay
	$(MAKE) -C xbmc/cores/dvdplayer/DVDDemuxers
	$(MAKE) -C xbmc/cores/VideoRenderers 
	$(MAKE) -C xbmc/cores/VideoRenderers/VideoShaders 
dvdcodecs: dllloader
	$(MAKE) -C xbmc/cores/dvdplayer/Codecs
cdrip:
	$(MAKE) -C xbmc/cdrip
libcmyth: dllloader 
	$(MAKE) -C xbmc/lib/libcmyth
eventclients:
	$(MAKE) -C tools/EventClients
librtmp:
	$(MAKE) -C xbmc/lib/libRTMP
libxbms:
	$(MAKE) -C xbmc/lib/libXBMS
libexif: dllloader
	$(MAKE) -C xbmc/lib/libexif
librtv:
	$(MAKE) -C xbmc/lib/libRTV
libxdaap:
	$(MAKE) -C xbmc/lib/libXDAAP
papcodecs: dllloader linux
	$(MAKE) -C xbmc/cores/paplayer/AACCodec
	$(MAKE) -C xbmc/cores/paplayer/AC3Codec
	$(MAKE) -C xbmc/cores/paplayer/ADPCMCodec
	$(MAKE) -C xbmc/cores/paplayer/CubeCodec
	$(MAKE) -C xbmc/cores/paplayer/DCACodec
	$(MAKE) -C xbmc/cores/paplayer/flac-1.2.1
	$(MAKE) -C xbmc/cores/paplayer/GYMCodec
	if test $(ARCH) != "x86_64-linux"; then \
		$(MAKE) -C xbmc/cores/paplayer/MACDll; \
		$(MAKE) -C xbmc/cores/paplayer/ModuleCodec; \
		$(MAKE) -C xbmc/cores/paplayer/SPCCodec; \
	fi
	$(MAKE) -C xbmc/cores/paplayer/MIDCodec
	$(MAKE) -C xbmc/cores/paplayer/MPCCodec
	$(MAKE) -C xbmc/cores/paplayer/MP3Codec
	$(MAKE) -C xbmc/cores/paplayer/NSFCodec
	$(MAKE) -C xbmc/cores/paplayer/SIDCodec
	$(MAKE) -C xbmc/cores/paplayer/vorbisfile
	$(MAKE) -C xbmc/cores/paplayer/WavPackCodec
	$(MAKE) -C xbmc/cores/paplayer/YMCodec/StSoundLibrary
	
imagelib: dllloader
	$(MAKE) -C xbmc/lib/cximage-6.0 -f Makefile.linux ARCH=$(ARCH)
compile: guilib xbmc filesystem musicdatabase videodatabase cores paplayer dllloader exports xbox linux visualizations screensavers utils common tinyxml sqllite libscrobbler libgoahead unrarxlib libpython dvdplayer libupnp cdrip libcmyth librtmp libxbms libexif librtv libxdaap papcodecs dvdcodecs imagelib

xbmc.bin: $(wildcard xbmc/*.o xbmc/settings/*.o guilib/*.o guilib/tinyXML/*.o guilib/common/*.o xbmc/FileSystem/*.o xbmc/FileSystem/VideoDatabaseDirectory/*.o xbmc/FileSystem/MusicDatabaseDirectory/*.o xbmc/visualizations/*.o xbmc/screensavers/*.o xbmc/cores/*.o xbmc/cores/paplayer/*.o xbmc/linux/*.o xbmc/lib/sqLite/*.o xbmc/lib/libscrobbler/*.o xbmc/lib/libPython/*.o xbmc/lib/libPython/xbmcmodule/*.o xbmc/xbox/*.o xbmc/cores/DllLoader/*.o xbmc/cores/DllLoader/exports/*.o xbmc/cores/DllLoader/exports/util/*.o xbmc/utils/*.o xbmc/lib/UnrarXLib/*.o xbmc/lib/libGoAhead/*.o xbmc/cores/dvdplayer/*.o xbmc/cores/dvdplayer/DVDSubtitles/*.o xbmc/cores/dvdplayer/DVDInputStreams/*.o xbmc/cores/dvdplayer/DVDCodecs/*.o xbmc/cores/dvdplayer/DVDCodecs/Audio/*.o xbmc/cores/dvdplayer/DVDCodecs/Video/*.o xbmc/cores/dvdplayer/DVDCodecs/Overlay/*.o xbmc/cores/dvdplayer/DVDDemuxers/*.o xbmc/cores/dvdplayer/DVDCodecs/Overlay/libspucc/*.o xbmc/cores/VideoRenderers/*.o xbmc/cores/VideoRenderers/VideoShaders/*.o xbmc/cdrip/*.o xbmc/lib/libcmyth/*.o xbmc/lib/libRTMP/*.o) xbmc/lib/libXBMS/libxbms-@ARCH@.a xbmc/lib/libUPnP/libupnp-@ARCH@.a 
	g++ $(DEBUG_FLAGS) -o xbmc.bin xbmc/*.o xbmc/settings/*.o xbmc/cdrip/*.o guilib/*.o guilib/tinyXML/*.o guilib/common/*.o xbmc/FileSystem/*.o xbmc/FileSystem/VideoDatabaseDirectory/*.o xbmc/FileSystem/MusicDatabaseDirectory/*.o xbmc/visualizations/*.o xbmc/screensavers/*.o xbmc/cores/*.o xbmc/cores/paplayer/*.o xbmc/linux/*.o xbmc/lib/sqLite/*.o xbmc/lib/libscrobbler/*.o xbmc/lib/libPython/*.o xbmc/lib/libPython/xbmcmodule/*.o xbmc/xbox/*.o xbmc/cores/DllLoader/*.o xbmc/cores/DllLoader/exports/*.o xbmc/cores/DllLoader/exports/util/*.o xbmc/utils/*.o xbmc/lib/UnrarXLib/*.o xbmc/lib/libGoAhead/*.o xbmc/cores/dvdplayer/*.o xbmc/cores/dvdplayer/DVDSubtitles/*.o xbmc/cores/dvdplayer/DVDInputStreams/*.o xbmc/cores/dvdplayer/DVDCodecs/*.o xbmc/cores/dvdplayer/DVDCodecs/Audio/*.o xbmc/cores/dvdplayer/DVDCodecs/Video/*.o xbmc/cores/dvdplayer/DVDCodecs/Overlay/*.o xbmc/cores/dvdplayer/DVDDemuxers/*.o xbmc/cores/dvdplayer/DVDCodecs/Overlay/libspucc/*.o xbmc/cores/VideoRenderers/*.o xbmc/cores/VideoRenderers/VideoShaders/*.o xbmc/lib/libcmyth/*.o xbmc/lib/libRTMP/*.o xbmc/lib/libGoAhead/libGoAheadD-@ARCH@.a xbmc/lib/libXBMS/libxbms-@ARCH@.a xbmc/lib/libUPnP/libupnp-@ARCH@.a xbmc/lib/libshout/libshout-@ARCH@.a xbmc/lib/libRTV/librtv-@ARCH@.a xbmc/lib/libXDAAP/libxdaap-@ARCH@.a xbmc/lib/libcdio/libcdio-@ARCH@.a xbmc/lib/libsmb/libsmbclient-@ARCH@.a $(LIBS) -rdynamic

xbmc-xrandr: xbmc-xrandr.c
	gcc -g -o xbmc-xrandr xbmc-xrandr.c -lXrandr -lXrender -lX11 

XBMCTex:
	$(MAKE) -C tools/XBMCTex/

install-bin: all # developement convenience target
	sudo cp xbmc.bin $(prefix)/share/xbmc

install: all install-datas install-web
	@echo "Copying XBMC binary to $(prefix)/share/xbmc/xbmc.bin"
	@cp xbmc.bin $(prefix)/share/xbmc/xbmc.bin
	@mkdir -p $(prefix)/bin
	@cp tools/Linux/xbmc.sh $(prefix)/bin/xbmc
	@chmod 755 $(prefix)/bin/xbmc
	@echo "Copying support and legal files,,,"
	@cp README.linux LICENSE.GPL *.txt xbmc-xrandr $(prefix)/share/xbmc/
	@echo "Done!"
	@echo "You can run XBMC with the command 'xbmc'"

install-datas: XBMCTex
	@echo "Creating target directories in $(prefix)/share/xbmc"
	@find language media screensavers scripts skin sounds userdata visualisations system -type d -not -iregex ".*svn.*" -exec mkdir -p $(prefix)/share/xbmc/"{}" \; -printf " -- %f                           \r"
	@echo "Copying system files to $(prefix)/share/xbmc"
	@# Arch independent files
	@find language media screensavers scripts sounds userdata visualisations system -regextype posix-extended -type f -not -iregex ".*svn.*|.*\.so|.*\.dll" -exec cp "{}" $(prefix)/share/xbmc/"{}" \; -printf " -- %f                           \r"
	@# Arch dependent files
	@find system -regextype posix-extended -type f -not -iregex ".*svn.*" -iregex ".*@ARCH@.*" -exec cp "{}" $(prefix)/share/xbmc/"{}" \; -printf " -- %f                           \r"
	@# PM3
	@find skin -regextype posix-extended -type f -not -iregex ".*svn.*|.*\.png|.*\.gif" -exec cp '{}' $(prefix)/share/xbmc/'{}' \; -printf " -- %f                            \r"

install-web:
	@mkdir -p $(prefix)/share/xbmc/web
	@unrar x -o+ web/Project_Mayem_III_webserver_v1.0.rar $(prefix)/share/xbmc/web

uninstall:
	@echo "Removing XBMC..."
	@rm -rf $(prefix)/share/xbmc $(prefix)/bin/xbmc
	@echo "Done!"

include Makefile.include
