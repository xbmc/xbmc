name: Test Semantic Module

on:
  push:
    branches: [master]
    paths:
      - 'xbmc/semantic/**'
      - 'cmake/**'
      - '.github/workflows/test-semantic.yml'
  pull_request:
    branches: [master]
    paths:
      - 'xbmc/semantic/**'
      - 'cmake/**'
      - '.github/workflows/test-semantic.yml'
  workflow_dispatch:

jobs:
  # Job 1: Quick static analysis (always works)
  static-analysis:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install cppcheck
        run: sudo apt-get update && sudo apt-get install -y cppcheck

      - name: Run cppcheck on semantic module
        run: |
          echo "=== Analyzing xbmc/semantic/ ==="
          cppcheck --enable=warning,style,performance \
            --suppress=missingIncludeSystem \
            --suppress=missingInclude \
            --suppress=unusedFunction \
            --suppress=noExplicitConstructor \
            --error-exitcode=0 \
            -I xbmc -I xbmc/semantic \
            xbmc/semantic/ 2>&1 | tee cppcheck-results.txt

          echo ""
          echo "=== Summary ==="
          ERRORS=$(grep -c '\[error\]' cppcheck-results.txt || echo 0)
          WARNINGS=$(grep -c '\[warning\]' cppcheck-results.txt || echo 0)
          echo "Errors: $ERRORS"
          echo "Warnings: $WARNINGS"

          # Fail if there are actual errors
          if [ "$ERRORS" -gt 0 ]; then
            echo "::error::Found $ERRORS cppcheck errors"
            grep '\[error\]' cppcheck-results.txt
            exit 1
          fi

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cppcheck-results
          path: cppcheck-results.txt

  # Job 2: CMake configuration check (may fail on missing deps)
  cmake-check:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    continue-on-error: true  # Don't fail the whole workflow

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          # Core build deps from sonarqube.yml
          sudo apt-get install -y \
            cmake ninja-build gcc g++ \
            libsqlite3-dev libcurl4-openssl-dev libssl-dev \
            libfmt-dev libspdlog-dev nlohmann-json3-dev \
            libpcre2-dev libtinyxml2-dev libflatbuffers-dev \
            libfribidi-dev libfreetype6-dev libfontconfig-dev \
            liblzo2-dev libbz2-dev zlib1g-dev \
            libpng-dev libjpeg-dev libgif-dev \
            libgl1-mesa-dev libglu1-mesa-dev libglew-dev \
            libdrm-dev libgbm-dev libegl1-mesa-dev \
            libx11-dev libxrandr-dev \
            libpulse-dev libasound2-dev \
            libdbus-1-dev libudev-dev uuid-dev \
            libgtest-dev python3-dev swig \
            libiso9660-dev libcdio-dev

      - name: Configure CMake (generate compile_commands.json)
        run: |
          mkdir -p build && cd build
          # Use internal versions of problematic dependencies
          cmake .. \
            -DCMAKE_BUILD_TYPE=Release \
            -DAPP_RENDER_SYSTEM=gl \
            -DENABLE_INTERNAL_FFMPEG=ON \
            -DENABLE_INTERNAL_EXIV2=ON \
            -DENABLE_INTERNAL_GTEST=ON \
            -DENABLE_INTERNAL_CROSSGUID=ON \
            -DENABLE_INTERNAL_FSTRCMP=ON \
            -DENABLE_INTERNAL_FLATBUFFERS=ON \
            -DENABLE_INTERNAL_UDFREAD=ON \
            -DENABLE_OPTICAL=OFF \
            -DENABLE_DVDCSS=OFF \
            -DENABLE_BLURAY=OFF \
            -DENABLE_CEC=OFF \
            -DENABLE_NFS=OFF \
            -DENABLE_SMBCLIENT=OFF \
            -DENABLE_UPNP=OFF \
            -DENABLE_AIRTUNES=OFF \
            -DENABLE_PULSEAUDIO=OFF \
            -DENABLE_AVAHI=OFF \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
            2>&1 | tee cmake-output.txt || true

          echo ""
          echo "=== CMake Result ==="
          if [ -f compile_commands.json ]; then
            echo "SUCCESS: compile_commands.json generated"
            echo "Semantic module entries:"
            grep -c "semantic" compile_commands.json || echo "0"
          else
            echo "FAILED: Check cmake-output.txt"
            tail -50 cmake-output.txt
          fi

      - name: Upload CMake logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cmake-logs
          path: |
            build/cmake-output.txt
            build/compile_commands.json
            build/CMakeFiles/CMakeError.log
          if-no-files-found: ignore

  # Job 3: Syntax validation with clang
  syntax-check:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install clang
        run: sudo apt-get update && sudo apt-get install -y clang

      - name: Check C++ syntax of semantic module headers
        run: |
          echo "=== Checking header syntax ==="
          ERRORS=0
          for header in $(find xbmc/semantic -name "*.h" -type f); do
            # Just check if headers are parseable (won't catch all errors without full includes)
            if ! clang++ -std=c++17 -fsyntax-only -x c++-header \
                -I xbmc -I xbmc/semantic \
                -DTARGET_POSIX -DTARGET_LINUX \
                "$header" 2>/dev/null; then
              echo "Note: $header has external dependencies (expected)"
            fi
          done
          echo "Header check complete"
