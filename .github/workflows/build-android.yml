name: Build Kodi Android APK

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 360

    steps:
      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache
          sudo apt-get clean
          df -h

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y autoconf bison build-essential curl default-jdk flex gawk git gperf lib32stdc++6 lib32z1 lib32z1-dev libcurl4-openssl-dev unzip zip zlib1g-dev cmake

      - name: Checkout source
        uses: actions/checkout@v4
        with:
          ref: fix-afr-standby

      - name: Setup Android SDK
        run: |
          mkdir -p $HOME/android-tools/android-sdk-linux
          cd $HOME/android-tools
          wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
          unzip -q commandlinetools-linux-9477386_latest.zip -d android-sdk-linux/
          cd android-sdk-linux/cmdline-tools/bin
          yes | ./sdkmanager --sdk_root=$HOME/android-tools/android-sdk-linux --licenses || true
          ./sdkmanager --sdk_root=$HOME/android-tools/android-sdk-linux platform-tools
          ./sdkmanager --sdk_root=$HOME/android-tools/android-sdk-linux "platforms;android-34"
          ./sdkmanager --sdk_root=$HOME/android-tools/android-sdk-linux "build-tools;33.0.1"
          ./sdkmanager --sdk_root=$HOME/android-tools/android-sdk-linux "ndk;21.4.7075529"

      - name: Create debug keystore
        run: |
          mkdir -p ~/.android
          keytool -genkey -keystore ~/.android/debug.keystore -v -alias androiddebugkey -dname "CN=Android Debug,O=Android,C=US" -keypass android -storepass android -keyalg RSA -keysize 2048 -validity 10000

      - name: Cache depends
        uses: actions/cache@v4
        with:
          path: ${{ github.workspace }}/tools/depends/xbmc-tarballs
          key: kodi-depends-tarballs-omega-arm

      - name: Build depends
        run: |
          cd tools/depends
          ./bootstrap
          ./configure --with-tarballs=${{ github.workspace }}/tools/depends/xbmc-tarballs --host=arm-linux-androideabi --with-sdk-path=$HOME/android-tools/android-sdk-linux --with-ndk-path=$HOME/android-tools/android-sdk-linux/ndk/21.4.7075529 --prefix=$HOME/android-tools/xbmc-depends --enable-debug=no
          make -j$(nproc)

      - name: Build binary addons
        run: |
          make -j$(nproc) -C tools/depends/target/binary-addons

      - name: Build Kodi
        run: |
          make -C tools/depends/target/cmakebuildsys
          cd build
          make -j$(nproc)

      - name: Package APK
        run: |
          cd build
          make apk

      - name: Find and upload APK
        uses: actions/upload-artifact@v4
        with:
          name: kodi-omega-afr-fix
          path: |
            *.apk
            build/*.apk
            tools/android/packaging/*.apk
